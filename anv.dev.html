<!DOCTYPE html><meta charset="utf-8">

<!--
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
-->
<head>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:800,400' rel='stylesheet' type='text/css'>


</head>
<body>
<style>
@font-face{
font-family: 'ssp';
src: url('../.fonts/SourceSansPro-Regular.otf');
src: format('opentype');
}
@font-face{
font-family: 'ssp';
src:url('../.fonts/SourceSansPro-Bold.otf');
src:format('opentype');
font-weight:bold;
src: format('opentype');
}

#dataTitle {

	width: 100px;
	background-color: #B2DCDD;
	border: #16B0C1 solid 2px;
	color: hsla(0,0%,30%,1);
	padding: 1px;
	margin: 10px;
	position: absolute;
	bottom:0px;
	right: 0px;
	display:inline-block;
	border-radius: .2em;
	text-align: center; 
	font-family: 'ssp', sans-serif;
	font-weight: 300;
	font-size: 15px;
}

#category {
	font-weight: bold;
	font-size:20px;
	text-shadow: 1px 1px hsl(0,0%,50%),
		-1px 1px hsl(0,0%,50%),
		1px -1px hsl(0,0%,50%),
		-1px -1px hsl(0,0%,50%);
}
	
#hurr {
	stroke-dasharray: 3,2;
}

.icon {
stroke: hsla(360,0%,20%,1);
}
.title {
	fill: hsla(0,0%,5%,.5);
	font: 20px arial, sans serif;
}
	
.background {
	fill: white;
	pointer-events: all;
}
.active {
	fill: #FFCB36;
}

.boundary, .active_boundary {
	stroke: white;
	fill: none;
}
.active_boundary {
	stroke-width: .02px;
	stroke: WhiteSmoke;
	
}	

.featured { 
	fill: #FFCB36;
	cursor:pointer;
}
.notFeatured {
	fill: #CFCDC9;
}

.boundary {
	stroke-width: 1px;
}


#dialogBoxUnit{
display:inline-block;
position:absolute;
margin-right: 156px;
height: 50px;
top:0px;
right:0px;
z-index:2;
}
#cdContainer{
position:absolute;
top:0px;
left:0px;
}
.popFront {
position:absolute;
top:0px; 
left:0px;
right:0px; 
bottom :0px;
cursor:pointer;

}

#dialogBoxContainer{
	position:absolute;
	top:0px;
	width:100%;
	height: 50px;
//	cursor:pointer;
	z-index:+1;
}
.dialogBoxOptionContainer {
	position:absolute;
	top:100%;
	left:0px;
}
.dialogBoxOption {
	position:relative;
	width: 60px;
	top:100%;
	padding:5px;
	background-color: whitesmoke;
	color: grey;
	display:block;
	opacity:.92;
}

.event {
	position:relative;
	display:inline-block;
}
.dialogBox, .selected , .dialogBoxOff, #globeContainer{
	margin: 0px 3px;
	padding: 4px 25px;
	position: relative;
	display: inline-block;
	text-align:left;
	font-size: 13pt;
	font-family: 'ssp', sans-serif;
	font-weight: 600;
	z-index:3;
	box-shadow: 2px 2px 1.5px #888888;
	width:100px;
	vertical-align:middle;
}


.dialogBoxOff, #globeContainer {
	color: white;
	background: #16B0C1;
	cursor:pointer;
	
}	



.selected {
	color: grey;
	background: whitesmoke;
	border-left, border-right, border-top: medium solid grey;
}

#swipeBox {
	background-color: hsla(37, 2%, 98%,.70);
//	outline: hsla(360, 0%, 40%, .7);
	border-width: 2px;
	white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
	white-space: -pre-wrap;      /* Opera 4-6 */
	white-space: -o-pre-wrap;    /* Opera 7 */
	white-space: pre-wrap;       /* css-3 */
	word-wrap: break-word;       /* Internet Explorer 5.5+ */
	word-break: break-all;
	-webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
	white-space: normal;
	position: absolute;
	bottom:0px;
	width: 100%;
	z-index:+1;
	
}
#swipeBack {
	background-color:hsla(0,0%,17%,.5);
	height:100%;
	width:100%;
	position:absolute;
	top:0px;
	z-index:0;	
}

#iframe1{ 
    -webkit-box-shadow: inset 0px 4px 3px rgba(50, 50, 50, 0.75);
    -moz-box-shadow:    inset 0px 4px 3px rgba(50, 50, 50, 0.75);
    box-shadow:         inset 0px 4px 3px rgba(50, 50, 50, 0.75);
	background-color:white;
	position: absolute;
	width:100%;
	height:100%;
	bottom:0px;
	-webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
	white-space: normal;
	display: float;
	
}

.hide {
	fill: none;
}
	
.pop {
	padding: 8px;
	border-radius: .4em;    
	opacity: 1e-6;
    background:#16B0C1;
	line-height:100%;
}

.tooltip {
	position: absolute;
	z-index: 2;
	visibility:hidden;
}

.tooltip:after {
	width: 0;
	height: 0;
	content:"";
	border-left: 20px solid transparent ;
	border-right: 20px solid transparent;
	border-bottom: 20px solid #16B0C1;                                                                                  
	position: absolute;
	top:-20px;
	left: 40%;
	
}

.popName {
font-family: 'ssp', sans-serif;
font-weight:800;
font-size:large;
color:#002A6C;
}

.popDetail {
font-family: 'ssp', sans-serif;
font-weight:400;
font-size: small;
color:white;
line-height:100%;

}

#tooltipImg {
display: block;
margin-right: auto;
margin-left: auto;
margin-top:4px;
margin-bottom:4px;
top:30px;
}


#globe, .hash {
	top:6px;	
	position:absolute;
	left:0px;
	margin-left: 5px;
	z-index:4;
	height:17px;
	width:17px;
//	margin-right: 10px;
}

.hash {
left:5px;
//top:4px;
}

#globeContainer {
	top: 0px;
	position: absolute;
	right: 0px;
	margin-left:5px;
	vertical-align:middle;
}
.ring {
  fill: none;
  stroke: #c7141a;
}



#ovContainer {
	position:absolute;
	height:95px;
	bottom:10px;
	left:10px;
	background-color:whitesmoke;
	white-space: nowrap;
}


#ovHead {
	color:#002A6C;
	position:relative;
	bottom:93px;
	margin-left:9px;
	font-family: 'ssp', sans-serif;
	font-weight:bold;
	line-height:100%;
	white-space:nowrap;
	font-size:17pt;
}

#ovSubHead{
	display:inline-block;
	margin:5px;
	margin-right:10px;
	font-size:12pt;
	font-weight:normal;
}

.nmTeal {
	color:#16B0C1;
	font-family: 'ssp', sans-serif;
	line-height:100%;
	
}
.ovElement {
	position:relative;
	display:inline-block;
	height: 50px;
	bottom:88px;
	vertical-align:text-top;
	text-align:left;
	line-height:80%;
	padding-left:20px;
	padding-right:20px;
}
.ovElemHead {
	position:absolute;
	top:0px;
	
}	


</style>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js" charset="utf-8"></script>

<script>
//colors of text
var alertContextColor = 'hsl(28,100%,47%)';

var mainTextColor = 'hsl(0,0%,40%)';

var contextColor = mainTextColor;

var	width = 960,
    height = 850,
    country,
    state;
var topMargin = 0, 
adjust = 52;

var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip");

//function changeContext (text) {
//	 d3.select("#context").style('color', alertContextColor).transition().duration(1000).text(text).style('color',contextColor);
//	}


//options needs to be created via looping through country files to determine types of content. For now created expressly

var featuredJSON = {
	"KHM":{
		"options":[],
		"type":"flood",
		"Story":[],
		"Infographic":[],
		"Video":[],
		"fullname":"Cambodia",
		"tagline":"Heavy rains fell over nearly all of Cambodia in the fall of 2011, with floodwaters spreading across 18 of 24 provinces, dampening prospects for 1.5 million people and destroying nearly 10 percent of the nation's crops."
	},
	"PHL":{
		"options":["Story","Video", "Infographic"],
		"Story":[{"Button":"old story","Name":"phl_story.html"},{"Button":"new story","Name":"phl_story2.html"}],
		"Video":[{"Button":"Plan","URL":"www.youtube.com/embed/HaEbhGiCVT8"},{"Button":"Kermit","URL":"www.youtube.com/embed/hpiIWMWWVco"}],
		"Infographic":[],
		"type":"storm",
		"fullname":"Philippines",
		"tagline":"On November 8, 2013, Typhoon Haiyan - known locally as Typhoon Yolanda - made landfall in the central Philippines. Considered one of the most powerful storms ever to make landfall, Haiyan brought flooding, triggered landslides, and caused widespread damage.",
		"ovTagline":"November 8, 2013 Typhoon Haiyan",
		"ovElements":[["affected","16", "MILLION"],["displaced","4.1", "MILLION"],["killed","6,201", ""]],
	},
	"JAM":{
		"options":[],		
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"storm",
		"fullname":"Jamaica",
		"tagline":"Jamaica has been hit by some 50 hurricanes and tropical storms since the late 1800s. Hurricane Ivan-- which hit in September 2004-- is among the most damaging storms in the island's recorded history."
		},
	"SDS":{
		"options":["Gallery"],		
		"Story":[],
		"Video":[],
		"Infographic":[],
		"Gallery":[{"Button":"Potatoes","Name":"sds_gallery.html"}],
		"type":"complex",
		"fullname":"South Sudan",
		"tagline":"Since conflict erupted in December 2013, more than 1.4 million people have been forced from their homes, up to one million are at risk of famine, and many more are affected by infectious disease outbreaks such as cholera.", 
		"ovTagline":"Conflict broke out in December 2013",
		"ovElements":[["famine","1", "MILLION"],["displaced","1.4", "MILLION"],["humanitarian","4", "MILLION"]]  
	
		},
	"HTI":{
		"options":[],	
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"quake",
		"disasterarray":{
			"magnitude":7,
			"depth":25, //in kilometers
			"epicenter":[-72.533,18.457],//Longitude Latitude
			},
		"fullname":"Haiti",
		"tagline":"On January 12, 2010, a magnitude 7.0 earthquake shook Haiti, killing 316,000 people and displacing 1.5 million others. The quake also created enough rubble to fill dump trucks lined up from Maine to Florida, twice."
	},
	"CHL":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"quake",
		"fullname":"Chile",
		"tagline":"So far with this amount of text it look like the popup box extends a little beyond the bottom of the map. There are a lot of ways we can get around this from limiting the amount of text we put in these boxes to having carl set the frame he allots to us to a height a little longer than the frame of the map to accomodate the extra popup box length. As for antarctica I think it is usefull for framing the map but if we are going to have Carl extend the frame it might be nice to take it out because we might not want something framing the bottom of the map if we are going to have a bunch of blank space underneath it anyways."
		},	
	"CRI":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"volcano",
		"fullname":"Costa Rica",
		"tagline":"The devastating destruction caused by the 1963 Irazu volcano eruption was witnessed by President John F. Kennedy and paved the way for OFDA's creation by underscoring the need for a lead U.S. agency to oversee foreign disaster response. Now, Costa Rica is home to one of OFDA's regional offices and is a hub for disaster risk reduction work in the region."
		},
	"GTM":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"quake",
		"fullname":"Guatemala",
		"tagline":"On February 4, 1976, a magnitude 7.6 earthquake shook Guatemala city and surrounding areas. Affecting more than 4.9 million people, it proved to be one of the worst natural disasters in Central America's modern history."
		},
	"JPN":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"quake",
		"fullname":"Japan",
		"tagline":"On March 11, 2011, a tsunami produced by a magnitude 9.0 earthquake struck the Fukushima Daiichi power plant, creating one of the most serious nuclear meltdowns in history. This marked the first time OFDA responded following a major nuclear crisis."
		},
	"MKD":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"quake",
		"fullname":"Macedonia",
		"tagline":"The magnitude 6.0 earthquake in 1963 that killed over 1,000 people and destroyed 75% of the city of Skopje revealed coordination challenges in providing disaster assistance that eventually lead to the establishment of OFDA."
		},
	"NZL":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"quake",
		"fullname":"New Zealand",
		"tagline":"On February, 22, 2011, a magnitude 6.3 earthquake rocked Christchurch, the country's second largest city. OFDA sent urban search and rescue teams to locate survivors and help coordinate international search efforts."
		},
	"RWA":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"complex",
		"fullname":"Rwanda",
		"tagline":"During a 100 day span in 1994, one of the worst genocides in history claimed the lives of an estimated 800,000 Rwandans."
		},
	"THA":{
		"options":[],
		"Story":[],
		"Video":[],
		"Infographic":[],
		"type":"flood",
		"fullname":"Thailand",
		"tagline":"When the worst flooding in half a century swept through Thailand in 2011 affecting 13.6 million people, OFDA provided assistance and also helped build the resilience of affected communities."
		}
};

var warehouse = [
	["miami",[-80.224, 25.7877]],
	["pisa",[10.4, 43.716]],
	["dubai",[55.333,24.95]]
]

//var featured = ["PHL","JAM","SDS","HTI"];
//var featuredMap = d3.set(featured);
var featuredMap = d3.map(featuredJSON);

function httpGet(theURL){
    var xmlHttp = null;
		
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theURL, false );
    xmlHttp.send( null );
    return xmlHttp.responseText;
};

//Tooptip variables

d3.select("body").append("div")
	.attr('id','frame')
	.style('width', width + 'px')
	.append('div')
		.style('overflow','hidden')
		.attr("id", "heading-Block")
		.style("display", "block")
		.style("width", width + "px");


var projection = d3.geo.cylindricalStereographic()
	.rotate([-32,0])
	.parallel(45)
    .scale(245)
    .translate([(width)/2,( height)/ 2]);

var trackWidth = .5;

var color = d3.interpolateLab("#99d594", "#fc8d59");

var path = d3.geo.path()
	.projection(projection);

d3.select("body").select("#frame")
		.attr("width", width + "px")
	.append("div")
		.attr("id","map")
		.style('position','relative')
		.style("width", width + "px")

var map = d3.select("body").select("#map")		

var svg = d3.select("body").select("#map").append("svg")
	.attr("width", width)
	.attr("height", height)
	.style("margin-top", topMargin);

svg.append("rect")
	.attr("class", "background")
	.attr("width", width)
	.attr("height", height)
	.on("click", country_clicked)
	

var g = svg.append("g");

function testDialog (dialogOptionBoolean, Media) {
	if (dialogOptionBoolean === 0) {
		d3.select("#" + Media).style("background-color","#16B0C1").style("color","white");	
		d3.selectAll(".dialogBoxOptionContainer").remove(); 
	}
}





d3.select("#map").append("div")
	.attr("id","cdContainer")
	.style("width", width + "px")
		.append("div") 
		.attr("id","globeContainer")

		.on("click", function() {
			d3.select("#ovContainer").remove();
			d3.select("#dataTitle").remove();
			d3.select("#hurr").remove();
			d3.select("#icon").remove();
			var xyz = [width / 2, height / 2, 1];
    		country = null;
			g.selectAll(".hide").classed("featured",true).classed("hide",false);
			d3.select("#dialogBoxUnit").remove();
			d3.select("#swipeBack").remove();
    		zoom(xyz);
			g.selectAll([".active", ".active_boundary"]).remove();
			d3.selectAll(".dialogBox").remove();
			isGlobal(xyz,null);
	})
	.on("mouseover", function() {
		d3.select(this).style("box-shadow", "2px 2px 4px rgb(136,136,136)");
	})
	.on("mouseout", function() {
		d3.select(this).style("box-shadow", "1px 1px 2px rgb(136,136,136)");
	})		
	.insert("span")
		.text("Map")
		.style("padding-left","3px")
		
	.append("img")
		.attr("id","globe")
		.attr("opacity",1)


var globe = new Image();

globe.onload = function(d){
	document.getElementById("globe").src = 'globe.png';
	}
globe.src = 'globe.png';


d3.json("countries_min.topo.json", function(error, us) {	
		g.append("g")
			.attr("id", "countries")
			.selectAll("path")
			.data(topojson.feature(us, us.objects.countries_min).features)
			.enter()
			.append("path")
			.attr("class", function(d) {
				var c = "";
				if (featuredMap.has(d.id)) {
					c = "featured";
					} else {
					c = "notFeatured";
					}
					return c; 
					})
			.attr("id", function(d) { return d.id; })

			.attr("d", path)
			.on("click", function(d) {
				var c;
				if (featuredMap.has(d.id)) {
					c = country_clicked(d); 
				} else {
					c = null;
				}
				return c;
				} )
			.on("mouseover", function(d) {
			 			
				if (featuredMap.has(d.id)) {
				  		var centroid = path.centroid(d);
						var selection = d.id;
						d3.select(this).style("fill","#E89624").transition().duration(2000).style("fill","#FFCB36");
					//		.attr("fill", "#E89624")
					//		.attr("fill-opacity", 1);
						tooltip
							.style("width", "200px")
							.attr("class","tooltip pop")
			    			.style("top", (centroid[1] + 29 ) + "px")
			    			.style("left", (centroid[0] - 95) + "px")
			    			.transition().duration(300)
			    			.style("opacity", 1)
							.style("visibility","visible")
			    			.style("display", "block");				
						tooltip.selectAll("div").remove();
						tooltip.selectAll("img").remove();
						tooltip.insert("div")
							.append('span')
							.text(function(d){
								return featuredJSON[selection].fullname;})				
							.attr("class", "popName");
						tooltip.append("img")
							.attr("id", "tooltipImg")
							.attr("width", 200)
							.style("opacity", "1"); 
						var image = new Image();
						image.onload = function(d){
							document.getElementById("tooltipImg").src = 'data/countries/' + selection.toLowerCase() + '/' + selection.toLowerCase() + '_popimg.jpg';}
						image.src = 'data/countries/' + selection.toLowerCase() + '/' + selection.toLowerCase() + '_popimg.jpg';
						tooltip.insert("div")
							.append('span')					
							.text(function(d){return featuredJSON[selection].tagline;}) 
							.attr("class", "popDetail");
						tooltip.append("div")
							.attr("class","popFront")
							.on("mouseout", function(d) {
								tooltip.transition().duration(700).style("opacity", 0);
								tooltip.transition().delay(705).each('start', function(){
									d3.selectAll(".popDetail, #tooltipImg, .popName").remove();
									d3.select(this).style("opacity",0);
								}).style("width","0px").style("height","0px")
							
							})
							.on("click", function() {
								country_clicked(d);
							})
						
				} else {
					 return	null;
				}
				

			})
					
			
			g.insert("g")
		  	.datum(topojson.mesh(us, us.objects.countries_min, function (a, b)  {
				return a !== b ; 
			}))
			.append("path")
			.attr("class","boundary")
			.attr("d",path);


for (i=0; i < warehouse.length; i++) {

			g.append("circle")
    			.attr("class", "warehouse")
    			.attr("transform", "translate(" + projection(warehouse[i][1]) + ")")
		//		.attr("cx", projection(warehouse[i][1])[0])
		//		.attr("cy",projection(warehouse[i][1])[1])
				.style("fill","#002A6C")
    			.attr("r", 3)
				.attr("id", function () {return warehouse[i][0];});
console.log(projection(warehouse[i][1]));
		
}

});




function isGlobal (xyz, FC) {
	if (xyz[2] === 1) {
//		d3.select("#" + FC.id).style("opacity",1)	
		d3.selectAll(".featured").style("fill","#FFCB36").style("cursor","pointer").style("opacity",1)
		.on("click", function(d){ country_clicked(d) } )
		.on("mouseover", function (d) {
			var centroid = path.centroid(d);
			var selection = d.id;
			d3.select(this).style("fill","#E89624").transition().duration(2000).style("fill","#FFCB36");
					//		.attr("fill", "#E89624")
					//		.attr("fill-opacity", 1);
			tooltip
				.style("width", "200px")
				.attr("class","tooltip pop")
			    .style("top", (centroid[1] + 29 ) + "px")
			    .style("left", (centroid[0] - 95) + "px")
			    .transition().duration(300)
			    .style("opacity", 1)
				.style("visibility","visible")
			    			.style("display", "block");				
						tooltip.selectAll("div").remove();
						tooltip.selectAll("img").remove();
						tooltip.insert("div")
							.append('span')
							.text(function(){
								return featuredJSON[selection].fullname;})				
							.attr("class", "popName");
						tooltip.append("img")
							.attr("id", "tooltipImg")
							.attr("width", 200)
							.style("opacity", "1"); 
						var image = new Image();
						image.onload = function(){
							document.getElementById("tooltipImg").src = 'data/countries/' + selection.toLowerCase() + '/' + selection.toLowerCase() + '_popimg.jpg';}
						image.src = 'data/countries/' + selection.toLowerCase() + '/' + selection.toLowerCase() + '_popimg.jpg';
						tooltip.insert("div")
							.append('span')					
							.text(function(d){return featuredJSON[selection].tagline;}) 
							.attr("class", "popDetail");
						tooltip.append("div")
							.attr("class","popFront")
							.on("mouseout", function() {
								tooltip.transition().duration(700).style("opacity", 0);
								tooltip.transition().delay(705).each('start', function(){
									d3.selectAll(".popDetail, #tooltipImg, .popName").remove();
									d3.select(this).style("opacity",0);
								}).style("width","0px").style("height","0px")
							
							})
							.on("click", function() {
								country_clicked(d);
							})
		})
		.on("mouseout", function (d) {
			d3.select("#" + d.id)
				.style("fill","#FFCB36")
				.attr("fill-opacity", function(d){return 1;})
			
		}) 
	} else if (xyz[2] > 1) {
		d3.selectAll(".featured").style("fill","#CFCDC9").style("cursor","default")
			.on("click", null )
			.on("mouseover", null )
			.on("mouseout", null )
		d3.select("#" + FC.id).style("opacity",0)	
	} else {
		return;
	}	
}	


function zoom(xyz) {
	g.transition()
		.duration(750)
		.attr("transform", "translate(" + projection.translate() + ")scale(" + xyz[2] + ")translate(-" + xyz[0] + ",-" + xyz[1] + ")")
		.select(".boundary").style("stroke-width", 1.0 / xyz[2] + "px")
	

}
//get content from server
function getHTTP(Media, Country, Name) {
//	var Country = Country;

	var Thing = featuredJSON[Country][Media];
	var ThingByName = {};
	NameFunct = function(d) {return d.Button;};
	Thing.forEach(function(d){ThingByName[NameFunct(d)] = d;})
	d3.select("#map").append("div")
		.attr("id","swipeBack")
		.append("div")
			.attr("id","swipeBox")
			.attr("height", "0px")
			.style("opacity", 0)
			.html(function () {
				var text;
				if (Media ===  "Video") {
					text =  "<iframe width=\"" + width + "\" height=\"" + height + "\" src=\"//" + ThingByName[Name].URL + "\" frameborder=\"0\" allowfullscreen></iframe>";
				} else if (Media === "Story") {
					
					text = "<iframe name='iframe1' id='iframe1' src=\"data/countries/" + Country.toLowerCase() + "/" + ThingByName[Name].Name + "\" seamless></iframe>";
				} else if (Media === "Infographic") {
					text = "<img width=\"" + width + "\" height=\"" + height + "\" src=\"data/countries/" + Country.toLowerCase() + "/graphic.jpg\">";
				} else if (Media === "Gallery") {
					text = "<iframe name='iframe1' scrolling=\"no\"  id='iframe1' src=\"data/countries/" + Country.toLowerCase() + "/" + ThingByName[Name].Name + "\" seamless></iframe>";
				} 
					
						
				return text;
		})//put up information screen
		.transition()
		.duration(800)
		.style('opacity', 1)
		.style("top", function () {
			if (Media ===  "Video") { return "35px"; } 
			else if (Media === "Story") { return "35px"; }
			else if (Media === "Infographic") { return "35px"; }
			else if (Media === "Gallery") { return "0px"; }
				 
		})
}
var dialogOptionBoolean;

function contentDialog(d) {
	dialogOptionBoolean = 0;
	var Country = d.id;
	d3.select("#map").select("#cdContainer").append("div")
			.attr("id","dialogBoxUnit")
			.on("mouseover", function () {
				d3.selectAll("dialogBoxOption").remove();
			})
			.selectAll("div")
			.data(function () {
				return featuredJSON[Country].options;
			})
			.enter()
			.insert("div")
				.attr("class", "event")
				.insert("div")
				.attr("class", "dialogBox dialogBoxOff")
				.style("text-align","left")
				.style('opacity', 1)
				.style('display','absolute')
				.attr('id', function(d) { return d; })
				.append('span') 
				.text(function (d) { 
				//	return d.toUpperCase(); 
					return d; 
				})
				.style("margin-left","8px");
			/*	.transition()
				.ease("linear")
				.delay(750)
				.each("start", function() {
					d3.select(this).style({"opacity":0});
				
					})
				
				.style('opacity', 1)
				.text(function (d) { 
					return d.toUpperCase(); 
				})
				.attr('id', function(d) { return d; });

			*/		
		
	
	d3.select('body').selectAll('.dialogBox')
	.on("click", function () {
		var Media = this.id;
		var Country = d.id;
		if (d3.select(this).classed("dialogBoxOff")) {
			d3.select("body").select("#swipeBack").remove();
			d3.select("body").selectAll(".dialogBox").classed("selected",false).classed('dialogBoxOff', true);
			d3.select(this).classed("selected", true).classed("dialogBoxOff",false);
			if ((featuredJSON[Country][Media]).length === 1) {
		//		var options = null;
				var Name = featuredJSON[Country][Media][0].Button;//;
				getHTTP(Media, Country, Name);
	//		return;
			} else {
			}
		
		} else if(d3.select(this).classed("selected")) {
			d3.select("#map").select("#swipeBox").remove();
			d3.select("#map").select("#swipeBack").remove();
			d3.select(this).classed("dialogBoxOff",true).classed('selected',false);
		} 
	})
	.on("mouseover", function (){
		dialogOptionBoolean += 1;
		d3.selectAll(".dialogBox").style("background-color","#16B0C1").style("color","white").on("mouseover.kill", function(){
			d3.selectAll(".dialogBoxOption").remove();
		});
		d3.select(this).style({'box-shadow':'2px 2px 3px #888888','background-color':'whitesmoke','color':'grey'}).on("mouseover.kill", null);
				
		var Media = this.id;
		var Country = d.id;
		if (featuredJSON[Country][Media].length === 1) {
			return;
		} else {	
			var options = featuredJSON[Country][Media];
	//		d3.select(this).classed("selected", true).classed("dialogBoxOff",false);
			d3.select(this).append("div")
				.attr("class","dialogBoxOptionContainer");

			d3.select(".dialogBoxOptionContainer").selectAll(".dialogBoxOption")				
				.data(options)
				.enter()
				.append("div")
				.attr("class","dialogBoxOption")
				.attr("id", function(d, i) { return "option_" + i ; })
				.text( function(d) { return d.Button; }) 
				.on("click", function(d) {
						
					d3.select("#" + Media).classed("selected", true).classed("dialogBoxOff",false);
					d3.select("body").select("#swipeBack").remove();

					Name = d.Button;
					getHTTP(Media, Country, Name);
				
				})
				.on("click.stop", function() {d3.event.stopPropagation(); })
				.on("mouseover", function () {
					dialogOptionBoolean += 1;
					d3.select(this).style("background-color","#CFCDC9").style("color","grey");
					})
				.on("mouseover.stop", function() {d3.event.stopPropagation(); })
				.on("mouseout.change", function () {
					dialogOptionBoolean -=1;
					d3.select(this).style("background-color","whitesmoke").style("color","grey");
					setTimeout(function() {testDialog(dialogOptionBoolean, Media)}, 0);
					})
				.on("mouseout.stop", function() {d3.event.stopPropagation(); });


			}
	})
	.on("mouseout", function () {
		var Media = this.id;
		dialogOptionBoolean -= 1;
		d3.select(this).style({'box-shadow':'1px 1px 1.5px #888888'});//,'background-color':'#16B0C1','color':'whitesmoke'});
		setTimeout(function() {testDialog(dialogOptionBoolean, Media)}, 0);
	});
	
	d3.select("body").selectAll(".dialogBox").append("img")
		.attr("class","hash")
		.attr("src", "hash.png")
		.attr("id", function (i) { 
			return "image_" + i 
			})
		.style("height","17px")
		.style("width","17px")
		.attr("z-index",4);
	
}

function ov(feature) {
			d3.select("#map").append("div")
				.attr("id","ovContainer")
				.append("div")
					.attr("id","ovLine")
					.style("left","0px")
					.style("width","5px")
					.style("height","100%")
					.style("margin-right","5px")
					.style("background-color","#16B0C1");

			d3.select("#map").select("#ovContainer").append("div")
				.attr("id","ovHead")
				.text(function () {  return featuredJSON[feature.id].fullname; } )
				.append("span")
					.style("display","inline-block")
					.attr("class","nmTeal")
					.style("margin-left","5pt")
					.attr("id","ovSubHead")
					.text(function () {  return featuredJSON[feature.id].ovTagline; } ); 
				
			d3.select("#map").select("#ovContainer")
					.selectAll(".ovElement")
					.data(function () { return featuredJSON[feature.id].ovElements; })
					.enter()				
					.append("div")
						.attr("class","ovElement")
						.style("border-left", function (d,i) { 
							var border;
							if (i === 0) {
								border = "0px solid hsla(0,0%,0%,0)";
							} else {
								border = "1px solid #CFCDC9";
							}
								return border;
						})
						.html(function (d) {	
								var text;
								if (d[0] === "displaced") {
									text = "people displaced";
								} else if (d[0] === "famine") {
									text = "people at risk for famine";
								} else if (d[0] === "humanitarian") {
									text = "in need of humanitarian aid";
								} else if (d[0] === "affected") {
									text = "people affected";
								} else if (d[0] === "killed") {
									text = "people killed";
								} 
								return "<span class=nmTeal style=font-size:22pt;font-weight:bold>" + d[1] +  "</span>" + "&nbsp;<span class=nmTeal style=font-size:11pt;font-weight:bold>" + d[2] + "</span><br><span class=nmTeal style=font-size:11pt;font-weight:400;line-height:80%>" +  text + "</span>";
							})
}


function get_xyz(d) {
	var bounds = path.bounds(d);
	var w_scale = (bounds[1][0] - bounds[0][0]) / width;
	var h_scale = (bounds[1][1] - bounds[0][1]) / height;
	var z = .96 / Math.max(w_scale, h_scale);
	var x = (bounds[1][0] + bounds[0][0]) / 2;
	var y = (bounds[1][1] + bounds[0][1]) / 2 + (height / z / 6);
	return [x, y, z];
}

function zoom2ADM (d, xyz) {
	var FC = d;
	d3.json("data/json/states_" + d.id.toLowerCase() + ".topo.json", function(error, us) {
				g.append("g")
          			.attr("id", "states")
          			.selectAll("path")
          			.data(topojson.feature(us, us.objects.states).features)
          			.enter()
          			.append("path")
          			.attr("id", function(d) { return d.id; })
          			.attr("class", "active")
          			.attr("d", path)


				g.insert("g")
					.datum(topojson.mesh(us, us.objects.states, function(a, b) {
						return a !== b; 
					}))
					.append("path")
					.attr("class", "active_boundary")
					.attr("d", path);
        		zoom(xyz);
				isGlobal(xyz,FC);
	});
}



function country_clicked(d) {
	d3.selectAll(".popDetail, #tooltipImg, .popName").remove();
	d3.select(".tooltip").style("opacity",0).style("width","0px");	
	g.selectAll(["#states"]).remove();
	state = null;

	if (country) {
		g.selectAll( "#" + country.id ).style('display', null);

	}	

	if (d && country !== d) {
		var xyz = get_xyz(d);
		country = d;
		if ( featuredJSON[d.id].type == 'storm') {
		

		contentDialog(d);			
		
//		ov(d);
	//	changeContext("Click anywhere off country to see some of our other responses.");

//		g.selectAll( "#" + d.id ).classed(".hide");
		var zoomFactor = [1,1,.5];
		for(var i=0; i < zoomFactor.length; i++) {
				xyz[i] = zoomFactor[i] * xyz[i];
		}
		
		zoom2ADM(d,xyz);

			d3.json("data/countries/" + d.id.toLowerCase() + "/track.json", function(error, track) {

	
					var color_scale = d3.scale.quantile().domain([3,5]).range(colorbrewer.YlGnBu[5]);

					map.append("div")
						.attr("id", "dataTitle")
						.attr("class","pop")
					
        				.html("<p><span id=\"popYear\"</span><b>2013</b></span><br>" + track[0].month + " " + track[0].day + " " + track[0].hour + ":00<br>Category: <span style=\"color:" + color_scale(track[0].class) + "\">" + track[0].class + "</span></p>")
						.attr("font-family", "sans-serif");
					var dateTextChange = map.select('#dataTitle');
						
					var cat = dateTextChange.select('#category');	

					var line = d3.svg.line()
						.interpolate("cardinal")
						.x(function(d) {return projection([d.lon, d.lat])[0]; })
						.y(function(d) {return projection([d.lon, d.lat])[1]; });

					var baseHurrPath = svg.append("path")
						.attr("d",line(track))
						.attr("fill","none")
						.attr("stroke","none")
						.attr("stroke-width",0)

					var hurrPathEl = baseHurrPath.node();
					var hurrPathElLen = hurrPathEl.getTotalLength();

					var pt = hurrPathEl.getPointAtLength(0);
					
					var path_g = g.append("g")
									.attr("id","hurr");

                    var icon_g = g.append("g")
                    	.attr("transform", "translate(" + pt.x + "," + pt.y + "), scale("+(.05*track[0].class)+")")
						.attr("id","icon");
					
					var icon_bg = icon_g.append("circle")
    					.attr("r",20)
    					.attr("fill", "#ffffff")
    					.attr("class","icon");

  					var icon = icon_g.append("path")
    					.attr("d","m 20,-42 c -21.61358,0.19629 -34.308391,10.76213 -41.46346,18.0657 -7.155097,7.3036 -11.451337,17.59059 -11.599112,26.13277 0,14.45439 9.037059,26.79801 21.767213,31.69368 -14.965519,10.64929 -25.578236,6.78076 -37.671451,7.85549 C -4.429787,54.20699 14.03,37.263 23.12144,28.41572 32.2133,19.56854 34.6802,10.79063 34.82941,2.19847 c 0,-14.45219 -9.03405,-26.79679 -21.76113,-31.69364 14.90401,-10.54656 25.48889,-6.69889 37.55061,-7.77104 C 38.78869,-40.57565 29.11666,-41.95733 21.03853,-42 20.68954,-42.0105 20.34303,-42.0105 20,-42 z M 0.82306,-7.46851 c 4.72694,0 8.56186,4.27392 8.56186,9.54602 0,5.2725 -3.83492,9.54651 -8.56186,9.54651 -4.726719,0 -8.555958,-4.27401 -8.555958,-9.54651 0,-5.2721 3.829239,-9.54602 8.555958,-9.54602 z")
    
    					.attr("fill", color_scale(track[0].class))
    					.attr("class","icon");

  					var i = 0;
  
  					var animation = setInterval(function(){
      					pt = hurrPathEl.getPointAtLength(hurrPathElLen*i/track.length);
      					icon_g
        					.transition()
        					.ease("linear")							
        					.duration(150) //changed from 1000
        					.attr("transform", "translate(" + pt.x + "," + pt.y + "), scale("+(0.05*track[i].class)+"), rotate("+(i*15)+")");
      					icon
        					.transition()
        					.ease("linear")
        					.duration(150) //changed from 1000

        					.attr("fill", color_scale(track[i].class));
						
      					dateTextChange
        					.html("<p><b>2013</b><br>" + track[i].month + " " + track[i].day + " " + track[i].hour + ":00<br>Category: <span id=\"category\" style=\"color:" + color_scale(track[i].class) + "\">" + track[i].class + "</span></p>");
								

//						cat.text(track[i].class).style("color", color_scale(track[i].class));
							

      					//Draw the path, only when i > 0 in otder to have two points
      					if (i>0){
        					color0 = color_scale(track[i-1].class);
        					color1 = color_scale(track[i].class);

        					var activatedTrack = new Array();
        
        					activatedTrack.push(track[i-1]);
        					activatedTrack.push(track[i]);

        					var color = d3.interpolateLab(color0, color1);
        					path_g.selectAll("path"+i)
        					.data(quad(sample(line(activatedTrack), 1)))
        					.enter().append("path")
          						.style("fill", function(d) { return color(d.t);})
          						.style("stroke", function(d) { return color(d.t); })
          						.attr("d", function(d) { return lineJoin(d[0], d[1], d[2], d[3], trackWidth); });
      					}
					      	i = i + 1;
          					if (i==track.length)
            					clearInterval(animation)
  					},150);
				path_xyz = get_xyz(path_g);

				});
			
			
				// Sample the SVG path string "d" uniformly with the specified precision.
				function sample(d, precision) {
  					var path = document.createElementNS(d3.ns.prefix.svg, "path");
  					path.setAttribute("d", d);

  					var n = path.getTotalLength(), t = [0], i = 0, dt = precision;
  					while ((i += dt) < n) t.push(i);
  					t.push(n);

  					return t.map(function(t) {
    					var p = path.getPointAtLength(t), a = [p.x, p.y];
    					a.t = t / n;
    					return a;
  					});
				}

				// Compute quads of adjacent points [p0, p1, p2, p3].
				function quad(points) {
  					return d3.range(points.length - 1).map(function(i) {
    					var a = [points[i - 1], points[i], points[i + 1], points[i + 2]];
    					a.t = (points[i].t + points[i + 1].t) / 2;
    					return a;
 				 	});
				}

				// Compute stroke outline for segment p12.
				function lineJoin(p0, p1, p2, p3, width) {
  					var u12 = perp(p1, p2),
      					r = width / 2,
      					a = [p1[0] + u12[0] * r, p1[1] + u12[1] * r],
      					b = [p2[0] + u12[0] * r, p2[1] + u12[1] * r],
      					c = [p2[0] - u12[0] * r, p2[1] - u12[1] * r],
      					d = [p1[0] - u12[0] * r, p1[1] - u12[1] * r];

  					if (p0) { // clip ad and dc using average of u01 and u12
    					var u01 = perp(p0, p1), e = [p1[0] + u01[0] + u12[0], p1[1] + u01[1] + u12[1]];
    					a = lineIntersect(p1, e, a, b);
    					d = lineIntersect(p1, e, d, c);
  					}

					if (p3) { // clip ab and dc using average of u12 and u23
    					var u23 = perp(p2, p3), e = [p2[0] + u23[0] + u12[0], p2[1] + u23[1] + u12[1]];
    						b = lineIntersect(p2, e, a, b);
    						c = lineIntersect(p2, e, d, c);
  					}

  					return "M" + a + "L" + b + " " + c + " " + d + "Z";
					}

				// Compute intersection of two infinite lines ab and cd.
				function lineIntersect(a, b, c, d) {
  					var x1 = c[0], x3 = a[0], x21 = d[0] - x1, x43 = b[0] - x3,
      					y1 = c[1], y3 = a[1], y21 = d[1] - y1, y43 = b[1] - y3,
      					ua = (x43 * (y1 - y3) - y43 * (x1 - x3)) / (y43 * x21 - x43 * y21);
  					return [x1 + ua * x21, y1 + ua * y21];
				}

				// Compute unit vector perpendicular to p01.
				function perp(p0, p1) {
  					var u01x = p0[1] - p1[1], u01y = p1[0] - p0[0],
      					u01d = Math.sqrt(u01x * u01x + u01y * u01y);
  					return [u01x / u01d, u01y / u01d];
				}	
   		}

		else if ( featuredJSON[d.id].type == 'quake') {		
		var zoomFactor = [1,1,.5];
		for(var i=0; i < zoomFactor.length; i++) {
				xyz[i] = zoomFactor[i] * xyz[i];
		}	



			contentDialog(d);			
			zoom2ADM(d,xyz); 			

		setTimeout(function() {			
			g.append("circle")
    			.attr("class", "dot")
				.style("opacity",0)
				.transition().delay(700)
    	//		.attr("transform", "translate(" + projection(featuredJSON[d.id].disasterarray.epicenter) + ")")
				.attr("cx", projection(featuredJSON[d.id].disasterarray.epicenter)[0])
				.attr("cy",projection(featuredJSON[d.id].disasterarray.epicenter)[1])
				.style("fill","#c7141a")
    			.attr("r", 6 / xyz[2])
				.style("opacity",1);			
			var animation = setInterval(function() {
  				g.append("circle")
      				.attr("class", "ring")
      				.attr("transform", "translate(" + projection(featuredJSON[d.id].disasterarray.epicenter) + ")")
      			//	.attr("r", 0)
					.attr("r", 4 / xyz[2] )
      				.style("stroke-width", 3 / xyz[2])
      				.style("stroke", "red")
    			.transition()
      				.ease("linear")
      				.duration(6000)
      				.style("stroke-opacity", 1e-6)
      				.style("stroke-width", 1 / xyz[2]) 
      				.style("stroke", "brown")
      				.attr("r", 160 / xyz[2] )
      				.remove();
			}, 800);
			},200);




			
	

			console.log(xyz);

			d3.selectAll(".background, #globeContainer")
				.on("click.stop", function() {
					clearInterval(animation);		
					svg.select(".dot").remove();
					svg.selectAll(".ring").remove();
					d3.selectAll(".background, #globeContainer")
						.on("click.stop", null);
					
				})
				
		}

		else if ( featuredJSON[d.id].type == "complex") {
			contentDialog(d);
						
			var feature = d;	
			g.selectAll( "#" + d.id ).classed(".hide");
			zoom2ADM(d,xyz);

			ov(d);
					
		}		

		else {		
		
		var zoomFactor = [1,1,.5];
		for(var i=0; i < zoomFactor.length; i++) {
				xyz[i] = zoomFactor[i] * xyz[i];
		}		
			contentDialog(d);			
	
			g.selectAll( "#" + d.id ).classed(".hide");
			zoom2ADM(d,xyz);
			return;
    	}
	} else {
		d3.select("#ovContainer").remove();
		d3.select("#dataTitle").remove();
		d3.select("#hurr").remove();
		d3.select("#icon").remove();
		var xyz = [width / 2, height / 2, 1];
    	country = null;
		d3.select("#dialogBoxContainer").remove();
    	zoom(xyz);
		isGlobal(xyz, null); 
		d3.selectAll(".dialogBox").remove();
		
  	}

}
/*
function state_clicked(d) {
  g.selectAll("#cities").remove();

  if (d && state !== d) {
    var xyz = get_xyz(d);
    state = d;

    country_code = state.id.substring(0, 3).toLowerCase();
    state_name = state.properties.name;

    d3.json("data/json/cities_" + country_code + ".topo.json", function(error, us) {
      g.append("g")
        .attr("id", "cities")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.cities).features.filter(function(d) { return state_name == d.properties.state; }))
        .enter()
        .append("path")
        .attr("id", function(d) { return d.properties.name; })
        .attr("class", "city")
        .attr("d", path.pointRadius(20 / xyz[2]));i
	g.append("g")
	

      zoom(xyz);
    });      
  } else {
    state = null;
    country_clicked(country);
  }
}
*/

/*$(window).resize(function() {
  var w = $("#map").width();
  svg.attr("width", w);
  svg.attr("height", w * height / width);

});
*/
</script>
